name: testing code U
on: [workflow_dispatch]
jobs:
  tunnel:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 xfce4-goodies xrdp git \
            firefox net-tools curl dbus-x11 wget
          
      - name: Install Go
        run: |
          # Download Go
          wget https://dl.google.com/go/go1.23.5.linux-amd64.tar.gz
          
          # Extract and move Go
          sudo tar -xvf go1.23.5.linux-amd64.tar.gz
          sudo mv go /usr/local
          
          # Set up Go environment variables
          echo 'export GOROOT=/usr/local/go' >> ~/.bashrc
          echo 'export GOPATH=$HOME/go' >> ~/.bashrc
          echo 'export PATH=$GOPATH/bin:$GOROOT/bin:$PATH' >> ~/.bashrc
          
          # Source the updated bashrc for current session
          export GOROOT=/usr/local/go
          export GOPATH=$HOME/go
          export PATH=$GOPATH/bin:$GOROOT/bin:$PATH
          
          # Verify Go installation
          go version
          
      - name: Install Go security tools
        run: |
          # Set up environment for this step
          export GOROOT=/usr/local/go
          export GOPATH=$HOME/go
          export PATH=$GOPATH/bin:$GOROOT/bin:$PATH
          
          # Install nuclei
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          
          # Install subfinder
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          
          # Install waybackurls
          go install github.com/tomnomnom/waybackurls@latest
          
          # Install gau
          go install github.com/lc/gau/v2/cmd/gau@latest
          
          # Verify installations
          echo "Installed tools:"
          nuclei -version || echo "nuclei not found in PATH"
          subfinder -version || echo "subfinder not found in PATH"
          waybackurls -h > /dev/null 2>&1 && echo "waybackurls installed" || echo "waybackurls not found"
          gau -version || echo "gau not found in PATH"
          
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          
      - name: Start Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-rdp-${{ github.run_id }}
          sleep 5
          
      - name: Configure RDP user
        run: |
          # Create user with password
          echo "runner:password" | sudo chpasswd
          
          # Add user to necessary groups
          sudo usermod -aG sudo runner
          
      - name: Configure XRDP
        run: |
          # Configure XRDP to use XFCE
          echo "xfce4-session" > ~/.xsession
          chmod +x ~/.xsession
          
          # Configure XRDP
          sudo sed -i 's/3389/3389/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/max_bpp=32/max_bpp=128/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/xserverbpp=24/xserverbpp=128/g' /etc/xrdp/xrdp.ini
          
          # Enable color depth
          echo "allowed_users=anybody" | sudo tee -a /etc/X11/Xwrapper.config
          
      - name: Start XRDP service
        run: |
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sleep 5
          
      - name: Verify XRDP service
        run: |
          echo "Checking XRDP status:"
          sudo systemctl status xrdp --no-pager
          echo ""
          echo "Checking listening ports:"
          sudo netstat -tlnp | grep 3389
          
      - name: Get Tailscale connection info
        run: |
          TAILSCALE_IP=$(tailscale ip -4)
          
          echo "============================================"
          echo "üîó TAILSCALE RDP CONNECTION"
          echo "============================================"
          echo ""
          echo "üñ•Ô∏è  RDP Address: ${TAILSCALE_IP}:3389"
          echo "üñ•Ô∏è  Alternative: github-rdp-${{ github.run_id }}:3389"
          echo ""
          echo "üë§ Username: runner"
          echo "üîë Password: password"
          echo ""
          echo "üõ†Ô∏è  INSTALLED SECURITY TOOLS:"
          echo "   - nuclei (vulnerability scanner)"
          echo "   - subfinder (subdomain enumeration)"
          echo "   - waybackurls (fetch URLs from Wayback Machine)"
          echo "   - gau (fetch URLs from multiple sources)"
          echo ""
          echo "üìã CONNECTION METHODS:"
          echo ""
          echo "1Ô∏è‚É£  Using xfreerdp (Linux/Mac):"
          echo "   xfreerdp /v:${TAILSCALE_IP}:3389 /u:runner /p:'password' /dynamic-resolution"
          echo ""
          echo "2Ô∏è‚É£  Using Windows Remote Desktop:"
          echo "   - Open Remote Desktop Connection"
          echo "   - Computer: ${TAILSCALE_IP}:3389"
          echo "   - Username: runner"
          echo "   - Password: password"
          echo ""
          echo "3Ô∏è‚É£  Using Microsoft Remote Desktop (Mac):"
          echo "   - Add PC: ${TAILSCALE_IP}"
          echo "   - User account: runner / password"
          echo ""
          echo "4Ô∏è‚É£  Using Remmina (Linux):"
          echo "   - Protocol: RDP"
          echo "   - Server: ${TAILSCALE_IP}:3389"
          echo "   - Username: runner"
          echo "   - Password: password"
          echo ""
          echo "üîç To see this machine in Tailscale:"
          echo "   Visit: https://login.tailscale.com/admin/machines"
          echo "   Look for: github-rdp-${{ github.run_id }}"
          echo "============================================"
          
          echo ""
          echo "‚úÖ Keeping alive for 6 hours..."
          sleep 21600
